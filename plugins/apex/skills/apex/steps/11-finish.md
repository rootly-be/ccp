# Step 11: Finish

## Purpose
Create branch, commit changes, and open a Merge Request on GitLab.

## Subagent Instructions

You are the Finish subagent. Your job is to package all changes into a proper git commit and MR.

### Inputs
- Task description
- Task ID
- All phase summaries
- List of all files modified/created across all phases
- Branch name (from Init phase)

### Process

1. **Verify branch**:
   - Confirm we're on the feature branch (not main/master)
   - If not, create and switch to `feat/{task-slug}` or `fix/{task-slug}`

2. **Update backlog** — If `docs/backlog.yaml` exists and task is linked to a story:
   - Read validation results, E2E results, acceptance criteria status
   - For each linked story:
     - Update `acceptance_criteria[].status` based on test/E2E results
     - Update `files_touched` from execution phase
     - If all AC are MET → set `status = DONE`, set `implemented_at = now()`
     - If some AC not MET → keep `status = IN_PROGRESS`, log which are missing
   - Recompute epic statuses and summary counters
   - Write `docs/backlog.yaml`
   - If `gitlab.auto_sync` → spawn `apex-gitlab-sync`:
     - Update issue labels (→ Status::Done)
     - Check AC checkboxes in issue description
     - Close issue if DONE
     - Close milestone if all epic stories DONE
     - Add completion comment with task summary

3. **Stage changes**:
   - `git add` all modified/created files
   - Verify staged changes match expected file list
   - Check for unintended changes (files not in the plan)

4. **Commit**:
   - Write a conventional commit message:
     ```
     {type}({scope}): {description}

     {body — summary of what was done and why}

     APEX Task: {task-id}
     Phases completed: {list}
     ```
   - Types: `feat`, `fix`, `refactor`, `docs`, `test`, `ci`, `chore`
   - Scope: derived from the primary area of change

5. **Push**:
   - Push branch to origin
   - Handle push errors (upstream not set, etc.)

6. **Create Merge Request** (if `-pr`):
   - Use `glab` CLI if available, otherwise provide manual instructions
   - MR title: same as commit subject
   - MR description:
     ```markdown
     ## Summary
     {task description}

     ## Changes
     {bullet list of key changes}

     ## Acceptance Criteria
     {from plan, with status}

     ## Testing
     {test results summary, if tests were run}

     ## Security
     {security scan summary, if run}

     ---
     *Generated by APEX workflow — Task {task-id}*
     ```
   - Labels: derive from task type
   - Assign to: user (if detectable)

### Output Format

```markdown
# Phase: Finish
# Task: {task-id}
# Timestamp: {ISO 8601}
# Status: PASS|FAIL

## Git
- Branch: `{branch name}`
- Commit: `{commit hash}` — {commit message}
- Push: SUCCESS|FAIL

## Merge Request
- URL: {MR URL}
- Title: {title}
- Status: CREATED|FAILED|MANUAL_NEEDED

## Summary
{final summary of the entire APEX workflow}

## Phase Results
| Phase | Status | Notes |
|-------|--------|-------|
| Init | PASS | |
| Analyze | PASS | |
| Plan | PASS | |
| Execute | PASS | |
| Validate | {status} | {notes} |
| Security | {status} | {notes} |
| Review | {status} | {notes} |
| Tests | {status} | {notes} |
| Docs | {status} | {notes} |
| CI/CD | {status} | {notes} |
| Finish | PASS | |
```

### Rules
- Never force push
- Never commit to main/master directly
- If `glab` is not available, provide the manual GitLab MR creation URL
- Include all relevant context in the MR description
- Keep commit messages concise but informative
